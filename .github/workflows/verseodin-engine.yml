name: Verseodin Engine

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  worker:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        worker:
          - name: worker1
            delay: 0
          - name: worker2
            delay: 180   # 3 minutes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Stagger start
        if: ${{ matrix.worker.delay > 0 }}
        run: sleep ${{ matrix.worker.delay }}

      - name: Install dependencies
        run: |
          cd verseodin_engine
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run verseodin engine
        env:
          SQS_QUEUE_URL: ${{ vars.SQS_QUEUE_URL }}
          OUTPUT_SQS_QUEUE_URL: ${{ vars.OUTPUT_SQS_QUEUE_URL }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          cd verseodin_engine
          python verseodin_engine.py --work-seconds 420 --total-seconds 600 --poll-seconds 3 --task-timeout 240
